<div class="main-container">
  <app-database></app-database>
  <app-Sidenav></app-Sidenav>
  <div class="main-content">
    <div class="fullscreen-dashboard">
      <div class="form-card">
        <h2 class="form-title"><i class="fas fa-chart-line"></i> Analyse de collection</h2>

        <!-- Error Message -->
        <div *ngIf="errorMessage" class="error-message" role="alert" aria-live="assertive">
          {{ errorMessage }}
        </div>

        <!-- Loading Indicator -->
        <div *ngIf="isLoading" class="loading" aria-live="polite">
          <i class="fas fa-spinner fa-spin"></i> Chargement...
        </div>

        <!-- Form -->
        <form class="form-container" novalidate>
          <!-- Display Mode Selection -->
          <div class="form-group">
            <label for="displayMode" class="form-label">Mode d'affichage :</label>
            <div class="select-wrapper">
              <select
                id="displayMode"
                [(ngModel)]="displayMode"
                name="displayMode"
                (ngModelChange)="onDisplayModeChange()"
                class="form-select"
                aria-describedby="displayModeHelp"
              >
                <option value="table">Tableau</option>
                <option value="chart">Graphique</option>
              </select>
              <i class="fas fa-chevron-down select-icon"></i>
            </div>
            <small id="displayModeHelp" class="form-text">Choisissez le mode de visualisation des données.</small>
          </div>

          <!-- Collection Selection -->
          <div class="form-group">
            <label for="collectionSelect" class="form-label">Collection :</label>
            <div class="select-wrapper">
              <select
                id="collectionSelect"
                [(ngModel)]="selectedCollection"
                name="collectionSelect"
                (ngModelChange)="onCollectionSelect()"
                [disabled]="!databaseName"
                class="form-select"
                aria-describedby="collectionSelectHelp"
                required
              >
                <option value="" disabled>Sélectionnez une collection</option>
                <option *ngFor="let col of collections" [value]="col">{{ col | titlecase }}</option>
              </select>
              <i class="fas fa-chevron-down select-icon"></i>
            </div>
            <small id="collectionSelectHelp" class="form-text">Sélectionnez une collection dans la base de données.</small>
          </div>

          <!-- Field Selection (Single-Select) -->
          <div class="form-group" *ngIf="fieldNames.length > 0">
            <label for="fieldSelect" class="form-label">Champ :</label>
            <div class="select-wrapper">
              <select
                id="fieldSelect"
                [(ngModel)]="selectedField"
                name="fieldSelect"
                (ngModelChange)="onFieldChange()"
                class="form-select"
                aria-describedby="fieldSelectHelp"
                required
              >
                <option value="" disabled>Sélectionnez un champ</option>
                <option *ngFor="let field of fieldNames" [value]="field">{{ field | titlecase }}</option>
              </select>
              <i class="fas fa-chevron-down select-icon"></i>
            </div>
            <small id="fieldSelectHelp" class="form-text">Choisissez un champ pour l'analyse ou le filtrage.</small>
          </div>

          <!-- Filter Checkbox -->
          <div class="form-group" *ngIf="selectedField">
            <label class="form-label">
              <input
                type="checkbox"
                [(ngModel)]="useFilter"
                name="useFilter"
                (ngModelChange)="onUseFilterChange()"
                aria-describedby="useFilterHelp"
              />
              Utiliser le filtre
            </label>
            <small id="useFilterHelp" class="form-text">Cochez pour appliquer un filtre sur les données.</small>
          </div>

          <!-- Filter Controls (Shown when useFilter is true) -->
          <ng-container *ngIf="useFilter && selectedField">
            <!-- Operator Selection -->
            <div class="form-group">
              <label for="operatorSelect" class="form-label">Opérateur :</label>
              <div class="select-wrapper">
                <select
                  id="operatorSelect"
                  [(ngModel)]="filterOperator"
                  name="operatorSelect"
                  (ngModelChange)="onOperatorChange()"
                  class="form-select"
                  aria-describedby="operatorSelectHelp"
                >
                  <option *ngFor="let op of operatorOptions[getOperatorKey(inferFieldType(selectedField))]" [value]="op">{{ op | titlecase }}</option>
                </select>
                <i class="fas fa-chevron-down select-icon"></i>
              </div>
              <small id="operatorSelectHelp" class="form-text">Sélectionnez un opérateur pour le filtre.</small>
            </div>

            <!-- Date Input Mode (for date fields) -->
            <div class="form-group" *ngIf="inferFieldType(selectedField) === 'date'">
              <label for="dateInputMode" class="form-label">Mode de date :</label>
              <div class="select-wrapper">
                <select
                  id="dateInputMode"
                  [(ngModel)]="dateInputMode"
                  name="dateInputMode"
                  (ngModelChange)="onDateInputModeChange()"
                  class="form-select"
                  aria-describedby="dateInputModeHelp"
                >
                  <option value="date">Date</option>
                  <option value="year">Année</option>
                </select>
                <i class="fas fa-chevron-down select-icon"></i>
              </div>
              <small id="dateInputModeHelp" class="form-text">Choisissez entre une date complète ou une année.</small>
            </div>

            <!-- Filter Value Input -->
            <div class="form-group">
              <label for="filterValue" class="form-label">Valeur :</label>
              <input
                id="filterValue"
                [(ngModel)]="filterValue"
                name="filterValue"
                (ngModelChange)="onFilterValueChange()"
                [pattern]="getPattern(selectedField)"
                class="form-input"
                aria-describedby="filterValueHelp"
              />
              <small id="filterValueHelp" class="form-text">
                Entrez une valeur pour le filtre (ex: "Paris" pour une chaîne, "2025-01-01" pour une date).
              </small>
            </div>
          </ng-container>

          <!-- Apply Button -->
          <div class="form-group" *ngIf="selectedField">
            <button
              type="button"
              (click)="applyFilter()"
              [disabled]="isLoading || (useFilter && !filterValue)"
              class="form-button"
              aria-label="Appliquer le filtre ou charger les données"
            >
              {{ isLoading ? 'Chargement...' : 'Appliquer' }}
            </button>
          </div>

          <!-- No Fields Message -->
          <div *ngIf="selectedCollection && fieldNames.length === 0 && !isLoading" class="no-data" role="alert" aria-live="polite">
            Aucun champ disponible pour la collection sélectionnée.
          </div>
        </form>

        <!-- Table Container -->
        <div
          class="table-container"
          *ngIf="displayMode === 'table' && collectionData.length > 0"
          role="grid"
          aria-label="Tableau des données"
        >
          <table class="data-table">
            <thead>
              <tr>
                <th *ngFor="let field of fieldNames" scope="col">{{ field | titlecase }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of collectionData">
                <td *ngFor="let field of fieldNames">
                  <ng-container [ngSwitch]="true">
                    <ng-container *ngSwitchCase="['isAdmin', 'isActive'].includes(field)">
                      {{ item[field] === true ? 'Oui' : item[field] === false ? 'Non' : '-' }}
                    </ng-container>
                    <ng-container *ngSwitchCase="['createdAt', 'updatedAt'].includes(field)">
                      {{ item[field] ? (item[field] | date:'short') : '-' }}
                    </ng-container>
                    <ng-container *ngSwitchDefault>
                      {{ item[field] ?? '-' }}
                    </ng-container>
                  </ng-container>
                </td>
              </tr>
            </tbody>
          </table>
          <p class="total-count">Total: {{ collectionData.length }} enregistrements</p>
        </div>

        <!-- Chart Container -->
        <div
          class="chart-container"
          *ngIf="displayMode === 'chart' && showChart && collectionData.length > 0"
          role="region"
          aria-label="Graphique des données"
        >
          <div #chart class="chart"></div>
        </div>

        <!-- No Data Message -->
        <div
          class="no-data"
          *ngIf="(displayMode === 'table' || displayMode === 'chart') && collectionData.length === 0 && !isLoading"
          role="alert"
          aria-live="polite"
        >
          Aucune donnée à afficher.
        </div>
      </div>
    </div>
  </div>
